# Node-RED-Ffmpeg-DVR
Live stream capture using FFMpeg segments in a ring buffer

'''
[{"id":"eba846a3.c3ea48","type":"exec","z":"b517deb3.7318f","command":"ffmpeg","addpay":true,"append":"","useSpawn":"true","timer":"","oldrc":false,"name":"","x":410,"y":260,"wires":[[],["bb88112c.add25"],["b08fff24.2dca6","bb88112c.add25"]]},{"id":"bb88112c.add25","type":"switch","z":"b517deb3.7318f","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"frame=","vt":"str"},{"t":"cont","v":" Opening","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":530,"y":260,"wires":[["d8c06de9.af761","11fdbe17.12b8d2"],["4b0253e5.dafa8c"]]},{"id":"d8c06de9.af761","type":"function","z":"b517deb3.7318f","name":"get time","func":"var i = msg.payload.indexOf(\"time=\");\nvar o =  msg.payload.substr(i + 5, 11);\nreturn {payload: o};","outputs":1,"noerr":0,"x":660,"y":240,"wires":[["51a2fa6.b4f2704"]]},{"id":"b08fff24.2dca6","type":"json","z":"b517deb3.7318f","name":"","property":"payload","action":"obj","pretty":false,"x":530,"y":360,"wires":[["14768c9e.771d83"]]},{"id":"51a2fa6.b4f2704","type":"ui_text","z":"b517deb3.7318f","group":"e996c6e3.977028","order":3,"width":0,"height":0,"name":"","label":"up time:","format":"{{msg.payload}}","layout":"row-spread","x":800,"y":240,"wires":[]},{"id":"90aa707f.bc633","type":"function","z":"b517deb3.7318f","name":"cmd","func":"flow.set(\"file_names\", new Array());\nvar s = \"-i rtsp://192.168.101.120/unicast -vcodec copy -acodec copy -map 0 -f segment -strftime 1 -reset_timestamps 1 -segment_time \";\ns += Math.trunc(flow.get(\"frames\") / flow.get(\"fps\"));\ns += \" \" + flow.get(\"path\");\ns += \"%04Y-%02m-%02d-%02H-%02M-CAM.mkv\";\nreturn {payload: s};","outputs":1,"noerr":0,"x":270,"y":260,"wires":[["eba846a3.c3ea48"]]},{"id":"ac489b89.4c3eb8","type":"ui_text","z":"b517deb3.7318f","group":"e996c6e3.977028","order":4,"width":0,"height":0,"name":"rc","label":"return code:","format":"{{msg.payload}}","layout":"row-spread","x":790,"y":360,"wires":[]},{"id":"14768c9e.771d83","type":"change","z":"b517deb3.7318f","name":"code","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.code","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":360,"wires":[["ac489b89.4c3eb8"]]},{"id":"8783cd49.ddabd","type":"ui_button","z":"b517deb3.7318f","name":"","group":"4fc6d69.aab3928","order":4,"width":0,"height":0,"passthru":true,"label":"Start","color":"","bgcolor":"","icon":"","payload":"0","payloadType":"str","topic":"","x":150,"y":260,"wires":[["90aa707f.bc633","b7bb6b9e.2f0b88"]]},{"id":"4b0253e5.dafa8c","type":"function","z":"b517deb3.7318f","name":"get file","func":"var s = msg.payload.indexOf(\"Opening\");\nvar e = msg.payload.indexOf(\".mkv\");\nvar f =  msg.payload.substr(s + 9, e - s - 5);\nvar fa = flow.get(\"file_names\");\ns = fa.push(f);\ne = flow.get(\"files_max\");\nreturn {payload: f, count: s, max: e};","outputs":1,"noerr":0,"x":650,"y":280,"wires":[["875ce9b0.6fd128","852243f0.444a6","dd165972.d87f08"]]},{"id":"875ce9b0.6fd128","type":"ui_text","z":"b517deb3.7318f","group":"e996c6e3.977028","order":2,"width":0,"height":0,"name":"","label":"filename:","format":"{{msg.payload}}","layout":"row-spread","x":800,"y":280,"wires":[]},{"id":"11fdbe17.12b8d2","type":"function","z":"b517deb3.7318f","name":"get frame","func":"var o = msg.payload.indexOf(\"fps=\") - 1;\no = msg.payload.substring(6, o).trim();\nvar f = parseInt(o) % flow.get(\"frames\");\nf = Math.floor(1000 * f / flow.get(\"frames\"))/10;\nreturn {payload: f, topic: o};","outputs":1,"noerr":0,"x":660,"y":200,"wires":[["cf5df7e4.4599b8"]]},{"id":"b7bb6b9e.2f0b88","type":"link out","z":"b517deb3.7318f","name":"outDVRStart","links":["de150998.30ca88"],"x":235,"y":220,"wires":[]},{"id":"de150998.30ca88","type":"link in","z":"b517deb3.7318f","name":"inDVRInfo","links":["b7bb6b9e.2f0b88"],"x":695,"y":160,"wires":[["51a2fa6.b4f2704","ac489b89.4c3eb8","875ce9b0.6fd128","cf5df7e4.4599b8"]]},{"id":"680778b9.11ce18","type":"ui_button","z":"b517deb3.7318f","name":"","group":"4fc6d69.aab3928","order":5,"width":0,"height":0,"passthru":true,"label":"Stop","color":"","bgcolor":"","icon":"","payload":"0","payloadType":"str","topic":"","x":150,"y":300,"wires":[["b7bb6b9e.2f0b88","4762e56a.080c2c"]]},{"id":"4762e56a.080c2c","type":"change","z":"b517deb3.7318f","name":"kill","rules":[{"t":"set","p":"kill","pt":"msg","to":"SIGTERM","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":300,"wires":[["eba846a3.c3ea48"]]},{"id":"cf5df7e4.4599b8","type":"ui_gauge","z":"b517deb3.7318f","name":"","group":"e996c6e3.977028","order":1,"width":0,"height":0,"gtype":"donut","title":"","label":"%","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":790,"y":200,"wires":[]},{"id":"780c74d8.75425c","type":"alexa-local","z":"b517deb3.7318f","devicename":"Recording","inputtrigger":false,"x":150,"y":360,"wires":[["20d0dd6c.a1af82"]]},{"id":"20d0dd6c.a1af82","type":"switch","z":"b517deb3.7318f","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":360,"wires":[["8783cd49.ddabd"],["680778b9.11ce18"]]},{"id":"9025fca6.4e13b","type":"ui_numeric","z":"b517deb3.7318f","name":"","label":"length (min):","group":"4fc6d69.aab3928","order":1,"width":0,"height":0,"passthru":true,"topic":"","format":"{{value}}","min":"1","max":"60","step":"1","x":410,"y":100,"wires":[["e53d8381.b1469"]]},{"id":"e53d8381.b1469","type":"function","z":"b517deb3.7318f","name":"set","func":"flow.set(\"fps\", 10)\nflow.set(\"frames\", msg.payload * 60 * flow.get(\"fps\"));\nreturn null;","outputs":1,"noerr":0,"x":550,"y":100,"wires":[[]]},{"id":"1a8c6398.4efc0c","type":"ui_numeric","z":"b517deb3.7318f","name":"files","label":"files to loop:","group":"4fc6d69.aab3928","order":2,"width":0,"height":0,"passthru":true,"topic":"","format":"{{value}}","min":0,"max":"100","step":"1","x":390,"y":140,"wires":[["8387ecf1.d9113"]]},{"id":"8387ecf1.d9113","type":"function","z":"b517deb3.7318f","name":"set","func":"flow.set(\"files_max\", msg.payload);\nreturn null;","outputs":1,"noerr":0,"x":550,"y":140,"wires":[[]]},{"id":"852243f0.444a6","type":"ui_text","z":"b517deb3.7318f","group":"e996c6e3.977028","order":2,"width":0,"height":0,"name":"","label":"files:","format":"{{msg.count}}","layout":"row-spread","x":1190,"y":320,"wires":[]},{"id":"dd165972.d87f08","type":"switch","z":"b517deb3.7318f","name":"","property":"count","propertyType":"msg","rules":[{"t":"gt","v":"max","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":930,"y":280,"wires":[["89a94db6.0da05"]]},{"id":"89a94db6.0da05","type":"function","z":"b517deb3.7318f","name":"shift file","func":"var fa = flow.get(\"file_names\");\nvar f = fa.shift();\nvar c = fa.length;\nreturn {payload: f, count: c};","outputs":1,"noerr":0,"x":1060,"y":280,"wires":[["852243f0.444a6","352016e4.42a08a"]]},{"id":"352016e4.42a08a","type":"fs-ops-delete","z":"b517deb3.7318f","name":"Delete","path":"","pathType":"str","filename":"payload","filenameType":"msg","x":1190,"y":280,"wires":[[]]},{"id":"f885ed2d.a5f8","type":"function","z":"b517deb3.7318f","name":"set","func":"flow.set(\"path\", msg.payload)\nreturn null;","outputs":1,"noerr":0,"x":550,"y":60,"wires":[[]]},{"id":"6866964f.67a098","type":"ui_text_input","z":"b517deb3.7318f","name":"","label":"path:","group":"4fc6d69.aab3928","order":3,"width":0,"height":0,"passthru":true,"mode":"text","delay":300,"topic":"","x":390,"y":60,"wires":[["f885ed2d.a5f8"]]},{"id":"f6943934.ab8d68","type":"inject","z":"b517deb3.7318f","name":"onStart","topic":"","payload":"/home/admin/local/cam","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"1","x":120,"y":60,"wires":[["3da6dc87.f960d4","5d1229f5.ceb358","55ac2769.019618"]]},{"id":"3da6dc87.f960d4","type":"function","z":"b517deb3.7318f","name":"init","func":"return {payload: \"/home/admin/local/cam/\"};","outputs":1,"noerr":0,"x":250,"y":60,"wires":[["6866964f.67a098"]]},{"id":"5d1229f5.ceb358","type":"function","z":"b517deb3.7318f","name":"init","func":"return {payload: 15};","outputs":1,"noerr":0,"x":250,"y":100,"wires":[["9025fca6.4e13b"]]},{"id":"55ac2769.019618","type":"function","z":"b517deb3.7318f","name":"init","func":"return {payload: 10};","outputs":1,"noerr":0,"x":250,"y":140,"wires":[["1a8c6398.4efc0c"]]},{"id":"e996c6e3.977028","type":"ui_group","z":"","name":"Progress","tab":"b735df7.b412f2","order":2,"disp":true,"width":"6","collapse":false},{"id":"4fc6d69.aab3928","type":"ui_group","z":"","name":"Recorder","tab":"b735df7.b412f2","order":1,"disp":true,"width":"6","collapse":false},{"id":"b735df7.b412f2","type":"ui_tab","z":"","name":"DVR","icon":"dashboard"}]
'''
